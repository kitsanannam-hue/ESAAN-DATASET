<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thai-Jazz Cross-Cultural Music Dataset Explorer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        h1 {
            font-size: 2.5em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        .subtitle { color: #666; font-size: 1.1em; }
        .ai-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            margin-left: 10px;
            vertical-align: middle;
        }
        .ai-active { background: #10b981; color: white; }
        .ai-inactive { background: #f59e0b; color: white; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        .stat-label {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .search-section {
            background: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        input[type="text"], select {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        input[type="text"]:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        button {
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: opacity 0.3s;
        }
        button:hover { opacity: 0.9; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-secondary {
            background: #f5f5f5;
            color: #333;
        }
        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .tab {
            padding: 12px 24px;
            background: #f5f5f5;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .content-area {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            min-height: 400px;
        }
        .result-item {
            padding: 15px;
            border-left: 4px solid #667eea;
            background: #f9f9f9;
            margin-bottom: 15px;
            border-radius: 5px;
        }
        .page-number {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            margin-bottom: 8px;
        }
        .context { color: #555; line-height: 1.6; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        th {
            background: #f5f5f5;
            font-weight: 600;
            color: #667eea;
        }
        tr:hover { background: #f9f9f9; }
        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .feature-card {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            cursor: pointer;
            transition: all 0.3s;
        }
        .feature-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .feature-name {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 8px;
        }
        .feature-category {
            display: inline-block;
            background: #e0e7ff;
            color: #667eea;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-bottom: 10px;
        }
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-top: 20px;
        }
        .chart-container {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 10px;
            position: relative;
            height: 300px;
        }
        .chart-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }
        .export-section {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .filter-section {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            width: 90%;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #999;
            padding: 5px;
        }
        .relationship-card {
            background: linear-gradient(135deg, #f9f9f9 0%, #fff 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }
        .relationship-card h4 {
            color: #667eea;
            margin-bottom: 10px;
        }
        .relationship-row {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
        }
        .relationship-label {
            font-weight: 600;
            color: #666;
            min-width: 120px;
        }
        .ai-response {
            background: linear-gradient(135deg, #e0e7ff 0%, #f3e8ff 100%);
            padding: 20px;
            border-radius: 10px;
            margin-top: 15px;
        }
        .ai-section {
            margin-bottom: 15px;
        }
        .ai-section h5 {
            color: #667eea;
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Thai-Jazz Cross-Cultural Music Dataset</h1>
            <p class="subtitle">
                Interactive exploration of 680-page PhD dissertation analysis
                <span id="ai-status" class="ai-badge ai-inactive">AI Loading...</span>
            </p>
        </header>

        <div class="stats-grid" id="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="total-entries">-</div>
                <div class="stat-label">Total Features</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="unique-pages">-</div>
                <div class="stat-label">Pages Analyzed</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="thai-music">-</div>
                <div class="stat-label">Thai Music Pages</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="jazz-count">-</div>
                <div class="stat-label">Jazz Pages</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="fusion-count">-</div>
                <div class="stat-label">Fusion Pages</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="ml-count">-</div>
                <div class="stat-label">ML Pages</div>
            </div>
        </div>

        <div class="search-section">
            <h2 style="margin-bottom: 20px;">Search Dataset</h2>
            <div class="search-box">
                <input type="text" id="search-input" placeholder="Search across all 680 pages...">
                <button onclick="performSearch()">Search</button>
            </div>
            <div id="search-results"></div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('overview')">Overview</button>
            <button class="tab" onclick="switchTab('visualizations')">Visualizations</button>
            <button class="tab" onclick="switchTab('features')">Features</button>
            <button class="tab" onclick="switchTab('relationships')">Thai-Jazz Connections</button>
            <button class="tab" onclick="switchTab('phin')">Phin Dataset</button>
            <button class="tab" onclick="switchTab('ai-analysis')">AI Analysis</button>
            <button class="tab" onclick="switchTab('export')">Export Data</button>
        </div>

        <div class="content-area" id="content-area">
            <div class="loading">Loading data...</div>
        </div>
    </div>

    <div class="modal" id="feature-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Feature Details</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div id="modal-body"></div>
        </div>
    </div>

    <script>
        let currentTab = 'overview';
        let stats = {};
        let aiAvailable = false;
        let charts = {};

        async function checkAIStatus() {
            try {
                const response = await fetch('/api/ai/status');
                const data = await response.json();
                aiAvailable = data.available;
                const badge = document.getElementById('ai-status');
                if (aiAvailable) {
                    badge.textContent = 'AI Ready';
                    badge.className = 'ai-badge ai-active';
                } else {
                    badge.textContent = 'AI Offline';
                    badge.className = 'ai-badge ai-inactive';
                }
            } catch (error) {
                console.error('Error checking AI status:', error);
            }
        }

        async function loadStats() {
            try {
                const response = await fetch('/api/summary');
                stats = await response.json();

                document.getElementById('total-entries').textContent = stats.total_entries || 0;
                document.getElementById('unique-pages').textContent = stats.unique_pages || 0;
                document.getElementById('thai-music').textContent = stats.thai_music_count || 0;
                document.getElementById('jazz-count').textContent = stats.jazz_count || 0;
                document.getElementById('fusion-count').textContent = stats.fusion_count || 0;
                document.getElementById('ml-count').textContent = stats.ml_count || 0;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function performSearch() {
            const query = document.getElementById('search-input').value;
            if (!query) return;

            const resultsDiv = document.getElementById('search-results');
            resultsDiv.innerHTML = '<div class="loading">Searching...</div>';

            const response = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
            const results = await response.json();

            if (results.length === 0) {
                resultsDiv.innerHTML = '<p>No results found.</p>';
                return;
            }

            resultsDiv.innerHTML = `<h3 style="margin-bottom: 15px;">Found ${results.length} results:</h3>` +
                results.map(r => `
                    <div class="result-item">
                        <span class="page-number">Page ${r.page}</span>
                        <div class="context">${r.context}</div>
                    </div>
                `).join('');
        }

        async function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = '<div class="loading">Loading...</div>';

            if (tab === 'overview') {
                showOverview();
            } else if (tab === 'visualizations') {
                showVisualizations();
            } else if (tab === 'features') {
                showFeatures();
            } else if (tab === 'relationships') {
                showRelationships();
            } else if (tab === 'phin') {
                showPhinDataset();
            } else if (tab === 'ai-analysis') {
                showAIAnalysis();
            } else if (tab === 'export') {
                showExport();
            }
        }

        function showOverview() {
            const html = `
                <h2>Dataset Overview</h2>
                <p style="color: #666; margin-bottom: 20px;">This dataset contains musical features extracted from a PhD dissertation on Thai-Jazz fusion music.</p>
                <div class="feature-grid">
                    ${Object.entries(stats.feature_counts || {}).slice(0, 12).map(([feature, count]) => `
                        <div class="feature-card">
                            <div class="feature-name">${feature}</div>
                            <div style="color: #666;">${count} instances</div>
                        </div>
                    `).join('')}
                </div>
            `;
            document.getElementById('content-area').innerHTML = html;
        }

        async function showVisualizations() {
            const html = `
                <h2>Data Visualizations</h2>
                <div class="charts-grid">
                    <div class="chart-container">
                        <div class="chart-title">Feature Categories</div>
                        <canvas id="categoryChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">Page Content Distribution</div>
                        <canvas id="pageChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">Notation Types</div>
                        <canvas id="notationChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">Regional Coverage</div>
                        <canvas id="regionalChart"></canvas>
                    </div>
                </div>
            `;
            document.getElementById('content-area').innerHTML = html;

            await Promise.all([
                loadCategoryChart(),
                loadPageChart(),
                loadNotationChart(),
                loadRegionalChart()
            ]);
        }

        async function loadCategoryChart() {
            try {
                const response = await fetch('/api/visualization/category-distribution');
                const data = await response.json();
                
                const ctx = document.getElementById('categoryChart').getContext('2d');
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: data.labels.map(l => l.replace('_', ' ')),
                        datasets: [{
                            data: data.values,
                            backgroundColor: data.colors
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom' } }
                    }
                });
            } catch (error) {
                console.error('Error loading category chart:', error);
            }
        }

        async function loadPageChart() {
            try {
                const response = await fetch('/api/visualization/page-analysis');
                const data = await response.json();
                
                const ctx = document.getElementById('pageChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'Pages',
                            data: data.values,
                            backgroundColor: data.colors
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } }
                    }
                });
            } catch (error) {
                console.error('Error loading page chart:', error);
            }
        }

        async function loadNotationChart() {
            try {
                const response = await fetch('/api/visualization/notation-types');
                const data = await response.json();
                
                const ctx = document.getElementById('notationChart').getContext('2d');
                new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            data: data.values,
                            backgroundColor: data.colors
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom' } }
                    }
                });
            } catch (error) {
                console.error('Error loading notation chart:', error);
            }
        }

        async function loadRegionalChart() {
            try {
                const response = await fetch('/api/visualization/regional-coverage');
                const data = await response.json();
                
                const ctx = document.getElementById('regionalChart').getContext('2d');
                new Chart(ctx, {
                    type: 'polarArea',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            data: data.values,
                            backgroundColor: data.colors.map(c => c + '80')
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom' } }
                    }
                });
            } catch (error) {
                console.error('Error loading regional chart:', error);
            }
        }

        async function showFeatures() {
            const categoriesResponse = await fetch('/api/features/categories');
            const categories = await categoriesResponse.json();

            let html = `
                <h2>Feature Catalog</h2>
                <div class="filter-section">
                    <select id="category-filter" onchange="filterFeatures()">
                        <option value="">All Categories</option>
                        ${categories.map(c => `<option value="${c}">${c.replace('_', ' ')}</option>`).join('')}
                    </select>
                    <input type="text" id="feature-search" placeholder="Search features..." style="max-width: 300px;" onkeyup="filterFeatures()">
                </div>
                <div class="feature-grid" id="features-grid">
                    <div class="loading">Loading features...</div>
                </div>
            `;
            document.getElementById('content-area').innerHTML = html;
            filterFeatures();
        }

        async function filterFeatures() {
            const category = document.getElementById('category-filter').value;
            const search = document.getElementById('feature-search').value;
            
            const response = await fetch(`/api/features/filter?category=${encodeURIComponent(category)}&search=${encodeURIComponent(search)}`);
            const features = await response.json();
            
            const grid = document.getElementById('features-grid');
            grid.innerHTML = features.map(f => `
                <div class="feature-card" onclick='showFeatureDetail(${JSON.stringify(f).replace(/'/g, "&#39;")})'>
                    <div class="feature-category">${(f.category || '').replace('_', ' ')}</div>
                    <div class="feature-name">${f.name}</div>
                    <div style="color: #999; font-size: 0.9em; margin-bottom: 8px;">${f.thai_term || ''}</div>
                    <div style="color: #666; font-size: 0.9em;">${f.description || ''}</div>
                </div>
            `).join('') || '<p>No features found.</p>';
        }

        function showFeatureDetail(feature) {
            document.getElementById('modal-title').textContent = feature.name;
            
            let html = `
                <p><strong>Thai Term:</strong> ${feature.thai_term || 'N/A'}</p>
                <p><strong>Category:</strong> ${(feature.category || '').replace('_', ' ')}</p>
                <p><strong>Description:</strong> ${feature.description || 'N/A'}</p>
                <p><strong>Application:</strong> ${feature.application || 'N/A'}</p>
                <p><strong>Examples:</strong> ${feature.examples || 'N/A'}</p>
                <p><strong>Source Pages:</strong> ${feature.source_pages || 'N/A'}</p>
            `;
            
            if (aiAvailable) {
                html += `
                    <button onclick='analyzeFeature(${JSON.stringify(feature).replace(/'/g, "&#39;")})' style="margin-top: 15px;" class="btn-success">
                        Analyze with AI
                    </button>
                    <div id="ai-analysis-result"></div>
                `;
            }
            
            document.getElementById('modal-body').innerHTML = html;
            document.getElementById('feature-modal').classList.add('active');
        }

        async function analyzeFeature(feature) {
            const resultDiv = document.getElementById('ai-analysis-result');
            resultDiv.innerHTML = '<div class="loading">Analyzing with AI...</div>';
            
            try {
                const response = await fetch('/api/ai/analyze-feature', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(feature)
                });
                const analysis = await response.json();
                
                if (analysis.error) {
                    resultDiv.innerHTML = `<p style="color: #ef4444;">${analysis.error}</p>`;
                    return;
                }
                
                resultDiv.innerHTML = `
                    <div class="ai-response">
                        <h4 style="color: #667eea; margin-bottom: 15px;">AI Analysis</h4>
                        ${analysis.thai_context ? `<div class="ai-section"><h5>Thai Context</h5><p>${analysis.thai_context}</p></div>` : ''}
                        ${analysis.jazz_parallel ? `<div class="ai-section"><h5>Jazz Parallel</h5><p>${analysis.jazz_parallel}</p></div>` : ''}
                        ${analysis.fusion_potential ? `<div class="ai-section"><h5>Fusion Potential</h5><p>${analysis.fusion_potential}</p></div>` : ''}
                        ${analysis.recommended_instruments ? `<div class="ai-section"><h5>Recommended Instruments</h5><p>${analysis.recommended_instruments}</p></div>` : ''}
                        ${analysis.listening_examples ? `<div class="ai-section"><h5>Listening Examples</h5><p>${analysis.listening_examples}</p></div>` : ''}
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<p style="color: #ef4444;">Error: ${error.message}</p>`;
            }
        }

        function closeModal() {
            document.getElementById('feature-modal').classList.remove('active');
        }

        async function showRelationships() {
            const response = await fetch('/api/relationships');
            const relationships = await response.json();
            
            const html = `
                <h2>Thai-Jazz Musical Connections</h2>
                <p style="color: #666; margin-bottom: 20px;">Discover how Thai musical techniques relate to Jazz concepts.</p>
                <div>
                    ${relationships.map(r => `
                        <div class="relationship-card">
                            <h4>${r.thai_feature} <span style="color: #999;">&harr;</span> ${r.jazz_equivalent}</h4>
                            <div class="relationship-row">
                                <span class="relationship-label">Connection:</span>
                                <span>${r.connection}</span>
                            </div>
                            <div class="relationship-row">
                                <span class="relationship-label">Fusion Tip:</span>
                                <span style="color: #10b981;">${r.fusion_tip}</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            document.getElementById('content-area').innerHTML = html;
        }

        async function showPhinDataset() {
            try {
                const [tuningResponse, laiResponse, datasetResponse] = await Promise.all([
                    fetch('/api/phin/tuning'),
                    fetch('/api/phin-lai-patterns'),
                    fetch('/api/phin-dataset')
                ]);
                
                const tuning = await tuningResponse.json();
                const lai = await laiResponse.json();
                const dataset = await datasetResponse.json();

                const html = `
                    <h2>Thai Phin Dataset</h2>
                    
                    <h3 style="margin-top: 30px; color: #667eea;">Tuning Systems</h3>
                    <table>
                        <thead><tr><th>Strings</th><th>Tuning</th><th>Notes</th><th>Description</th></tr></thead>
                        <tbody>
                            ${tuning.map(t => `
                                <tr>
                                    <td>${t.string_count}</td>
                                    <td><strong>${t.tuning}</strong></td>
                                    <td>${t.notes}</td>
                                    <td>${t.description}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>

                    <h3 style="margin-top: 30px; color: #667eea;">Lai Patterns</h3>
                    <div class="feature-grid">
                        ${lai.map(l => `
                            <div class="feature-card">
                                <div class="feature-name">${l.name_thai}</div>
                                <div style="color: #667eea; margin: 5px 0;">${l.name_english}</div>
                                <div style="color: #666; font-size: 0.9em; margin: 10px 0;">${l.meaning || ''}</div>
                                <div style="font-size: 0.85em;">
                                    <strong>Scale:</strong> ${l.scale_type}<br>
                                    <strong>Province:</strong> ${l.province || 'N/A'}
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <h3 style="margin-top: 30px; color: #667eea;">Master Artists</h3>
                    ${(dataset.artists || []).map(a => `
                        <div class="result-item" style="margin-bottom: 20px;">
                            <div style="font-size: 1.2em; font-weight: bold; color: #667eea; margin-bottom: 5px;">${a.name}</div>
                            <div style="color: #999; font-size: 0.9em; margin-bottom: 10px;">${a.province} - ${a.specialty}</div>
                            <div style="color: #555;">${a.description}</div>
                        </div>
                    `).join('')}
                `;
                document.getElementById('content-area').innerHTML = html;
            } catch (error) {
                document.getElementById('content-area').innerHTML = `<p style="color: #ef4444;">Error loading Phin dataset: ${error.message}</p>`;
            }
        }

        function showAIAnalysis() {
            const html = `
                <h2>AI-Powered Analysis</h2>
                ${!aiAvailable ? `
                    <div style="background: #fef3c7; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <p style="color: #92400e;"><strong>AI Analysis Unavailable</strong></p>
                        <p style="color: #a16207;">Add your OPENAI_API_KEY to enable AI-powered musical analysis.</p>
                    </div>
                ` : ''}
                
                <div style="margin-bottom: 30px;">
                    <h3 style="margin-bottom: 15px;">Explain Musical Concept</h3>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <input type="text" id="concept-input" placeholder="Enter a musical concept (e.g., Thao, Pentatonic, Modal Jazz)" style="flex: 1;">
                        <button onclick="explainConcept()" ${!aiAvailable ? 'disabled' : ''}>Explain</button>
                    </div>
                    <div id="concept-result"></div>
                </div>
                
                <div style="margin-bottom: 30px;">
                    <h3 style="margin-bottom: 15px;">Compare Scale Systems</h3>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                        <input type="text" id="thai-scale" placeholder="Thai scale (e.g., Lai Yai)" style="flex: 1; min-width: 200px;">
                        <input type="text" id="jazz-scale" placeholder="Jazz scale (e.g., Dorian)" style="flex: 1; min-width: 200px;">
                        <button onclick="compareScales()" ${!aiAvailable ? 'disabled' : ''}>Compare</button>
                    </div>
                    <div id="scale-result"></div>
                </div>
                
                <div>
                    <h3 style="margin-bottom: 15px;">Generate Fusion Suggestion</h3>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                        <select id="jazz-style" style="flex: 1; min-width: 200px;">
                            <option value="Modal Jazz">Modal Jazz</option>
                            <option value="Bebop">Bebop</option>
                            <option value="Cool Jazz">Cool Jazz</option>
                            <option value="Fusion">Fusion</option>
                            <option value="Free Jazz">Free Jazz</option>
                        </select>
                        <button onclick="generateFusion()" ${!aiAvailable ? 'disabled' : ''}>Generate</button>
                    </div>
                    <div id="fusion-result"></div>
                </div>
            `;
            document.getElementById('content-area').innerHTML = html;
        }

        async function explainConcept() {
            const concept = document.getElementById('concept-input').value;
            if (!concept) return;
            
            const resultDiv = document.getElementById('concept-result');
            resultDiv.innerHTML = '<div class="loading">Analyzing...</div>';
            
            try {
                const response = await fetch('/api/ai/explain', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ concept })
                });
                const data = await response.json();
                
                if (data.error) {
                    resultDiv.innerHTML = `<p style="color: #ef4444;">${data.error}</p>`;
                    return;
                }
                
                resultDiv.innerHTML = `
                    <div class="ai-response">
                        ${data.definition ? `<div class="ai-section"><h5>Definition</h5><p>${data.definition}</p></div>` : ''}
                        ${data.thai_usage ? `<div class="ai-section"><h5>Thai Usage</h5><p>${data.thai_usage}</p></div>` : ''}
                        ${data.jazz_usage ? `<div class="ai-section"><h5>Jazz Usage</h5><p>${data.jazz_usage}</p></div>` : ''}
                        ${data.fusion_application ? `<div class="ai-section"><h5>Fusion Application</h5><p>${data.fusion_application}</p></div>` : ''}
                        ${data.practice_tips ? `<div class="ai-section"><h5>Practice Tips</h5><p>${data.practice_tips}</p></div>` : ''}
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<p style="color: #ef4444;">Error: ${error.message}</p>`;
            }
        }

        async function compareScales() {
            const thaiScale = document.getElementById('thai-scale').value;
            const jazzScale = document.getElementById('jazz-scale').value;
            if (!thaiScale || !jazzScale) return;
            
            const resultDiv = document.getElementById('scale-result');
            resultDiv.innerHTML = '<div class="loading">Comparing...</div>';
            
            try {
                const response = await fetch('/api/ai/compare-scales', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ thai_scale: thaiScale, jazz_scale: jazzScale })
                });
                const data = await response.json();
                
                if (data.error) {
                    resultDiv.innerHTML = `<p style="color: #ef4444;">${data.error}</p>`;
                    return;
                }
                
                resultDiv.innerHTML = `
                    <div class="ai-response">
                        ${data.similarities ? `<div class="ai-section"><h5>Similarities</h5><p>${data.similarities}</p></div>` : ''}
                        ${data.differences ? `<div class="ai-section"><h5>Differences</h5><p>${data.differences}</p></div>` : ''}
                        ${data.fusion_possibilities ? `<div class="ai-section"><h5>Fusion Possibilities</h5><p>${data.fusion_possibilities}</p></div>` : ''}
                        ${data.example_progression ? `<div class="ai-section"><h5>Example Progression</h5><p>${data.example_progression}</p></div>` : ''}
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<p style="color: #ef4444;">Error: ${error.message}</p>`;
            }
        }

        async function generateFusion() {
            const jazzStyle = document.getElementById('jazz-style').value;
            
            const resultDiv = document.getElementById('fusion-result');
            resultDiv.innerHTML = '<div class="loading">Generating fusion concept...</div>';
            
            try {
                const featuresResponse = await fetch('/api/ml-dataset/features');
                const features = await featuresResponse.json();
                
                const response = await fetch('/api/ai/fusion-suggestion', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        thai_features: features.slice(0, 5),
                        jazz_style: jazzStyle 
                    })
                });
                const data = await response.json();
                
                if (data.error) {
                    resultDiv.innerHTML = `<p style="color: #ef4444;">${data.error}</p>`;
                    return;
                }
                
                resultDiv.innerHTML = `
                    <div class="ai-response">
                        ${data.title ? `<h4 style="color: #667eea; margin-bottom: 15px;">${data.title}</h4>` : ''}
                        ${data.concept ? `<div class="ai-section"><h5>Concept</h5><p>${data.concept}</p></div>` : ''}
                        ${data.structure ? `<div class="ai-section"><h5>Structure</h5><p>${data.structure}</p></div>` : ''}
                        ${data.arrangement_tips ? `<div class="ai-section"><h5>Arrangement Tips</h5><p>${data.arrangement_tips}</p></div>` : ''}
                        ${data.mood ? `<div class="ai-section"><h5>Mood</h5><p>${data.mood}</p></div>` : ''}
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<p style="color: #ef4444;">Error: ${error.message}</p>`;
            }
        }

        function showExport() {
            const html = `
                <h2>Export Dataset</h2>
                <p style="color: #666; margin-bottom: 30px;">Download the dataset in your preferred format for further research and analysis.</p>
                
                <div style="margin-bottom: 30px;">
                    <h3 style="margin-bottom: 15px;">Thai-Jazz Features</h3>
                    <div class="export-section">
                        <a href="/api/export/features/json" download><button class="btn-success">Download JSON</button></a>
                        <a href="/api/export/features/csv" download><button class="btn-secondary">Download CSV</button></a>
                    </div>
                </div>
                
                <div style="margin-bottom: 30px;">
                    <h3 style="margin-bottom: 15px;">Phin Dataset</h3>
                    <div class="export-section">
                        <a href="/api/export/phin/json" download><button class="btn-success">Download JSON</button></a>
                        <a href="/api/export/phin/csv" download><button class="btn-secondary">Download CSV (Lai Patterns)</button></a>
                    </div>
                </div>
                
                <div style="margin-bottom: 30px;">
                    <h3 style="margin-bottom: 15px;">Complete ML Dataset</h3>
                    <div class="export-section">
                        <a href="/api/export/complete/json" download><button class="btn-success">Download JSON</button></a>
                    </div>
                </div>
                
                <div style="background: #f0f9ff; padding: 20px; border-radius: 10px; margin-top: 30px;">
                    <h4 style="color: #0369a1; margin-bottom: 10px;">Dataset Information</h4>
                    <ul style="color: #0c4a6e; margin-left: 20px;">
                        <li>15 cross-cultural musical features</li>
                        <li>9 Phin Lai patterns with tuning systems</li>
                        <li>680 pages of dissertation content analyzed</li>
                        <li>309 musical notations extracted</li>
                        <li>4 Thai regional music traditions covered</li>
                    </ul>
                </div>
            `;
            document.getElementById('content-area').innerHTML = html;
        }

        document.getElementById('search-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') performSearch();
        });

        window.onclick = function(event) {
            const modal = document.getElementById('feature-modal');
            if (event.target === modal) {
                closeModal();
            }
        }

        checkAIStatus();
        loadStats();
        showOverview();
    </script>
</body>
</html>
